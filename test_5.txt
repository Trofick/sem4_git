SELECT
        borrower_id                                                                         AS Originator_ID
        ,id                                                                                 AS Loan_ID
        ,issued_at::date                                                                    AS Sign_Date
        ,CASE
            WHEN period = 'P1D'
                THEN 'Payday loan'
            WHEN period = 'P1M'
                THEN 'Installment'
	    ELSE period
            END                                                                             AS Product_type
	,max_day_overdue                                                                    AS OverDue_Days
        ,text_eng                                                                           AS Status
        ,amount                                                                             AS Loan_Amount
        ,amt_principal                                                                      AS Remaining_Principal
        ,(issued_at::date) + term                                                           AS Due_Date
        ,CASE 
            WHEN finished_at::date <= '2022-12-31' -- менять
                THEN finished_at::date
            END                                                                             AS Realization_Date
        ,(principal + fee + penalty)                                                        AS Instalment
        , principal                                                                         AS Principal
        ,fee                                                                                AS Interest
        ,penalty                                                                            AS Others
        ,is_it_refinance
        ,cnt_issued_wo_can
    FROM tengeda_creditconveyer.credit c

        LEFT JOIN LATERAL (
            SELECT
                is_it_refinance                                                             AS is_it_refinance
                ,(1 - is_it_refinance) * (1 - is_cancelled) * is_decided * is_issued        AS cnt_issued_wo_can
            FROM tengeda_reporting.common_values cv

            WHERE 1 = 1
                AND requested_date >= '2020-01-01'
                AND issued_at::date between '2020-01-01' and '2022-12-31' -- менять
                AND cv.credit_id = c.id
        ) cv ON TRUE

        LEFT JOIN LATERAL (
            SELECT
                CASE
              WHEN cs.due_principal + cs.overdue_principal 
                       + COALESCE(cs.principal_adjusted, 0::numeric) > 0::numeric
                  THEN cs.due_principal + cs.overdue_principal 
                           + COALESCE(cs.principal_adjusted, 0::numeric)
                    ELSE 0::numeric 
              END                                                                           AS amt_principal
            FROM tengeda_creditconveyer.credit_snapshot cs

            WHERE 1=1
                AND cs.credit_id = c.id
                AND date::date = '2022-12-31' -- менять
        ) cs ON TRUE
        
        LEFT JOIN LATERAL (
            SELECT
                SUM (all_principal_changes)                                                 AS all_principal_changes,
                SUM (fcs.paid_principal)                                                    AS principal,
                SUM (fcs.paid_fee)                                                          AS fee,
                SUM (fcs.paid_penalty)                                                      AS penalty
                ,MAX(curr_status)                                                           AS curr_status
                ,MAX(curr_dpd)                                                              AS max_day_overdue
                ,MAX(date)                                                                  AS curr_date
                ,credit_id
            FROM tengeda_creditconveyer.fact_credit_snapshot fcs

            WHERE 1=1
                AND fcs.credit_id = c.id
                AND date::date <= '2022-12-31'-- менять
            GROUP by credit_id
        ) fcs ON TRUE

      LEFT JOIN LATERAL (
            SELECT
                text_eng
            FROM kredit24_reporting.dict_status ds

            WHERE 1=1
                AND ds.id = fcs.curr_status
        ) ds ON TRUE


    WHERE 1=1
        AND issued_at is not null
        AND c.issued_at::date <= '2022-12-31' -- менять
        AND EXTRACT (YEAR FROM issued_at::date) != '2019'
        AND status != '1900'